apiVersion: apps/v1
kind: Deployment
metadata:
  name: runnermqtt4
  labels:
    app: runner
spec:
  replicas: 1
  selector:
    matchLabels:
      app: runner
  template:
    metadata:
      labels:
        app: runner
    spec:
      nodeSelector:
        worker: "5"
      hostname: runnermqtt4
      subdomain: benchnet
initContainers:
        - name: sysctl-tune
          image: alpine:3.20
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true
            runAsUser: 0
          command: ["sh","-lc"]
          args:
            - |
              set -u
              apk add --no-cache procps >/dev/null 2>&1 || true

              show() {
                for k in net/ipv4/udp_rmem_min net/ipv4/udp_wmem_min; do
                  p=/proc/sys/$(echo $k | tr . /)
                  printf "%s=" "$k"; [ -f "$p" ] && cat "$p" || echo NA
                done
              }

              setv() {
                k=$1; v=$2; p=/proc/sys/$(echo $k | tr . /)
                sysctl -w $k=$v >/dev/null 2>&1 || true
                [ -f "$p" ] && echo $v > "$p" 2>/dev/null || true
              }

              echo "=== before ==="; show
              # 將最小收/發緩衝提高到 64MiB（與 node 上限 64MiB 對齊）
              setv net.ipv4.udp_rmem_min 67108864
              setv net.ipv4.udp_wmem_min 67108864
              echo "=== after ==="; show
              echo "sysctl-tune done."
      containers:
        - env:
            - name: ADD_NODE_TO_SUFFIX
              value: "false"
            - name: DEPLOY_DIR
              value: /app/configs/builtin-test-suites/deployments
            - name: DEVICE_DIR
              value: /app/configs/builtin-test-suites/devices
            - name: DIST_MODE
              value: name
            - name: NODE_BASE
              value: runner4
            - name: RELEASE_COOKIE
              value: ps_bench_cookie
            - name: RUN_TAG
              value: dds_test
            - name: SCENARIO
              value: protocolsuite_smart_city_dds
            - name: SCEN_DIR
              value: /app/configs/builtin-test-suites/testcases
          image: docker.io/library/ps_bench-runner:latest
          imagePullPolicy: Never
          name: runnermqtt4
          volumeMounts:
            - name: shared
              mountPath: /app/out
              subPath: out
            - name: shared
              mountPath: /app/results
              subPath: result
      volumes:
        - name: shared
          persistentVolumeClaim:
            claimName: runnermqtt4-shared-pvc
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: runnermqtt4-shared-pvc
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 10Gi
  storageClassName: local-path