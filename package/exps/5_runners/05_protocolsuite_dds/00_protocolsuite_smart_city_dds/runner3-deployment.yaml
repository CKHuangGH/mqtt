apiVersion: apps/v1
kind: Deployment
metadata:
  name: runnermqtt3
  labels:
    app: runner
spec:
  replicas: 1
  selector:
    matchLabels:
      app: runner
  template:
    metadata:
      labels:
        app: runner
    spec:
      nodeSelector:
        worker: "4"
      hostname: runnermqtt3
      subdomain: benchnet
      initContainers:
        - name: sysctl-tune
          image: busybox:1.36
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true         # 需要寫 /proc/sys
            runAsUser: 0
          command: ["sh","-lc"]
          args:
            - |
              set -e
              # 調大 UDP / 核心緩衝與隊列
              sysctl -w net.core.rmem_max=134217728
              sysctl -w net.core.wmem_max=134217728
              sysctl -w net.core.rmem_default=4194304
              sysctl -w net.core.wmem_default=1048576
              sysctl -w net.core.netdev_max_backlog=16384
              sysctl -w net.ipv4.udp_mem="98304 131072 262144"
              sysctl -w net.ipv4.udp_rmem_min=262144
              sysctl -w net.ipv4.udp_wmem_min=262144
              # 打印確認
              echo "=== sysctl after tune ==="
              for k in \
                net/core/rmem_max net/core/rmem_default \
                net/core/wmem_max net/core/wmem_default \
                net/core/netdev_max_backlog \
                net/ipv4/udp_mem net/ipv4/udp_rmem_min net/ipv4/udp_wmem_min
              do
                printf "%s=" "$k"; cat /proc/sys/$k || true
              done
              echo "========================="
      containers:
        - env:
            - name: ADD_NODE_TO_SUFFIX
              value: "false"
            - name: DEPLOY_DIR
              value: /app/configs/builtin-test-suites/deployments
            - name: DEVICE_DIR
              value: /app/configs/builtin-test-suites/devices
            - name: DIST_MODE
              value: name
            - name: NODE_BASE
              value: runner3
            - name: RELEASE_COOKIE
              value: ps_bench_cookie
            - name: RUN_TAG
              value: dds_test
            - name: SCENARIO
              value: protocolsuite_smart_city_dds
            - name: SCEN_DIR
              value: /app/configs/builtin-test-suites/testcases
          image: docker.io/library/ps_bench-runner:latest
          imagePullPolicy: Never
          name: runnermqtt3
          volumeMounts:
            - name: shared
              mountPath: /app/out
              subPath: out
            - name: shared
              mountPath: /app/results
              subPath: result
      volumes:
        - name: shared
          persistentVolumeClaim:
            claimName: runnermqtt3-shared-pvc
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: runnermqtt3-shared-pvc
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 10Gi
  storageClassName: local-path